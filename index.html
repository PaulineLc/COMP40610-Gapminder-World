<html>

<head>
    <meta charset="utf-8">
    <title>Gapminder World</title>
    <script type="text/javascript" src="d3/d3.v3.js">
    </script>
    <script type="text/javascript" src="d3/d3.slider.js"></script>
    <link rel="stylesheet" type="text/css" href="stylesheet.css">
    <link rel="stylesheet" href="d3/d3.slider.css" />
</head>

<body>

    <script type="text/javascript">
        var dataset;
        var height = 600;
        var width = 1250;
        var padding = 30;
        var xScale;
        var yScale;
        var rScale;
        var rRangeMin = 3;
        var rRangeMax = 60;
        var xAxis;
        var yAxis;
        var svg;
        var yearSlider;
        var yearValues;

        d3.csv("Gapminder_All_Time.csv", function (error, data) {
            if (error) {
                console.log(error);
            } else {
                console.log("Data successfully loaded");

                //Create xScale
                xScale = d3.scale.log()
                    .domain([d3.min(data,
                            function (d) {
                                return parseInt(d.GDP);
                            }),
                             d3.max(data,
                            function (d) {
                                return parseInt(d.GDP);
                            })])
                    .range([padding, width - padding * 2]);

                //creates yScale
                yScale = d3.scale.linear()
                    .domain([d3.min(data,
                            function (d) {
                                return parseFloat(d.LifeExp);
                            }),
                             d3.max(data,
                            function (d) {
                                return parseFloat(d.LifeExp);
                            })])
                    .range([height - padding, padding]);

                //create rscale
                rScale = d3.scale.linear()
                    .domain([d3.min(data,
                            function (d) {
                                return parseInt(d.Population);
                            }),
                             d3.max(data,
                            function (d) {
                                return parseInt(d.Population);
                            })])
                    .range([rRangeMin, rRangeMax]);


                //Create dataset with year as keys
                dataset = d3.nest()
                    .key(function (d) {
                        return d.Year
                    })
                    .sortKeys(d3.ascending)
                    .map(data);

                //Create Year slider
                //get all unique years
                yearValues = d3.map(data, function (d) {
                    return d.Year;
                }).keys();
                //get years as integer
                for (var i = 0; i < yearValues.length; i++) {
                    yearValues[i] = +yearValues[i];
                };
                //sort years (just in case)
                yearValues.sort()

                yearSlider = d3.select("body")
                    .append("div")
                    .attr("width", "200px")
                    .call(d3.slider()
                        .axis(true)
                        .min(0)
                        .max(yearValues.length - 1)
                        .step(1)
                        .on("slide", function (evt, value) {
                            makeVisualization(yearValues[value])
                        }));

                // create X axis
                xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(function (d) {
                        return xScale.tickFormat(8, d3.format(",d"))(d)
                    });

                //create Y axis
                yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left")
                    .ticks(5);


                //Create svg
                svg = d3.select("body")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("id", "gapmindersvg");

                //Display current year
                svg.append("text")
                    .text(yearValues[0])
                    .attr("id", "currentyeardiplsayed")
                    .attr("x", 59)
                    .attr("y", 70)
                    .style("font-size", "48px")
                    .style("fill", "rgba(0, 0, 0, 0.3)");

                //Create X axis
                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + (height - padding) + ")")
                    .call(xAxis)
                    .call(xAxis);

                //Create Y axis
                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxis);

                //Make the visualisation
                makeVisualization(yearValues[0]);
            }

        });

        function makeVisualization(year) {

            var currYearData = dataset[year];

            var country_bubbles = svg.selectAll("circle")
                .data(currYearData, function key(d) {
                    return d.Code
                });

            country_bubbles
                .transition()
                .duration(1000)
                .attr("cx", function (d) {
                    return xScale(d.GDP);
                })
                .attr("cy", function (d) {
                    return yScale(d.LifeExp);
                })
                .attr("r", function (d) {
                    return rScale(d.Population);
                });

            country_bubbles.enter()
                .append("circle")
                .attr("id", function (d) {
                    return "circle-" + d.Code;
                })
                .on("mouseover", function (d) {
                    displayCountryName(d);
                })
                .on("mouseout", function (d) {
                    removeCountryName(d);
                })
                .attr("cx", function (d) {
                    return xScale(d.GDP);
                })
                .attr("cy", function (d) {
                    return yScale(d.LifeExp);
                })
                .attr("r", function (d) {
                    return rScale(d.Population);
                })
                .style("stroke", "black")
                .style("fill", function (d) {
                    return color(d.Region);
                });

            country_bubbles.exit().remove();

            d3.select("#currentyeardiplsayed")
                .text(year);
        }

        //displayCountryName() and removeCountryName implemented with the help of:
        //http://bl.ocks.org/WilliamQLiu/76ae20060e19bf42d774
        // Display country name when mouse is over the country bubble
        function displayCountryName(d) {
            svg.append("text")
                .transition()
                .duration(500)
                .attr({
                    id: "selectedCountry",
                    // Create an id for text so we can select it later for removing on mouseout
                    class: "countryname",
                    x: function () {
                        return (width - d.Country.length * 35);
                    },
                    y: 550
                })
                .style("font-size", "48px")
                .text(function () {
                    return d.Country;
                });

            svg.selectAll("circle")
                .transition()
                .duration(500)
                .style("opacity", 0.3)

            d3.select("#circle-" + d.Code)
                .transition()
                .duration(100)
                .style("opacity", 1);
        }

        //remove country name when mouse gets away from the vountry bubble
        function removeCountryName(d) {
            // Select text by id and then remove
            d3.select("#selectedCountry").remove();

            svg.selectAll("circle")
                .transition()
                .duration(200)
                .style("opacity", 1)
        }

        // Pick a color for the country bubble
        function color(region) {
            switch (region) {
            case "Asia":
                return "#ED61A5";

            case "Africa":
                return "#3B8CCB";

            case "Europe":
                return "#FBB82A";

            case "North America":
                return "#71BF44";

            case "South America":
                return "#71BF44";

            case "Australia":
                return "#ED61A5";

            case "Central America":
                return "#71BF44";

            case "Oceania":
                return "#ED61A5";

            }
        }
    </script>

</body>

</html>