<html>

<head>
    <meta charset="utf-8">
    <title>Gapminder World</title>
    <script type="text/javascript" src="d3/d3.v3.js">
    </script>
    <script type="application/javascript" src="d3/topojson.v1.min.js"></script>
    <script type="text/javascript" src="d3/d3.slider.js"></script>
    <script type="text/javascript" src="d3/datamaps.js"></script>
    <script type="application/javascript" src="d3/datamaps.world.js"></script>
    <link rel="stylesheet" type="text/css" href="stylesheet.css">
    <link rel="stylesheet" href="d3/d3.slider.css" />
    <link href="https://fonts.googleapis.com/css?family=Libre+Franklin" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Abhaya+Libre" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
</head>

<body>

    <h1>Income, agriculture and fertility: how the world shifted in the past 55 years</h1>

    <div id="map-wrapper">
        <div id="container1" class="map-div">
            <h2>Births per woman</h2>
            <p>(<span class="low">low fertility</span>, <span class="high">high fertility</span>)</p>

        </div>
        <div id="container2" class="map-div">
            <h2>Income per person</h2>
            <p>(<span class="low">low income</span>, <span class="high">high income</span>)</p>
        </div>
        <div id="container3" class="map-div">
            <h2>Agriculture (value-added,  % GDP)</h2>
            <p>(<span class="low">low percentage</span>, <span class="high">high percentage</span>)</p>
        </div>
    </div>

    <div class="spacer"></div>

    <div id="player"><img id="play-button" src="img/pause.png" width="18px" onclick="controlAutoplay()" alt="play/pause"></div>
    <div id="slider-wrapper">
        <div id="slider"></div>
    </div>

    <div class="spacer"></div>


    <div id="header-wrapper">

        <div style="text-align:center;">
            <div id="visualization-div"></div>
        </div>

    </div>


    <script type="text/javascript">
        // Global variables
        var dataset;
        var height = 640;
        var width = 1250;
        var padding = 50;
        var transitionDuration = 900;
        var xScale;
        var yScale;
        var rScale;
        var GDPColorScale;
        var AgriColorScale;
        var FertilityColorScale;
        var rRangeMin = 3;
        var rRangeMax = 30;
        var xAxis;
        var yAxis;
        var svg;
        var yearSlider;
        var yearValues;
        var autoplay;
        var autoplaying = true;

        d3.csv("data/consolidated_data.csv", function (error, data) {
            if (error) {
                console.log(error);
            } else {
                console.log("Data successfully loaded");

                //Below we will create the barebones of the canvas
                //Axis, scales, core svg elements...

                //Create xScale
                //Mapped to the GDP of each country
                xScale = d3.scale.log()
                    .domain([d3.min(data,
                        function (d) {
                            return parseFloat(d.GDP);
                        }), d3.max(data,
                        function (d) {
                            return parseFloat(d.GDP);
                        })])
                    .range([padding, width - padding * 2]);

                //creates yScale
                //mapped to the size of the agriculture sector as a % of GDP of each country
                yScale = d3.scale.linear()
                    .domain([0, 100])
                    .range([height - padding, padding]);

                //create rscale
                //mapped to the fertility of each country
                rScale = d3.scale.linear()
                    .domain([d3.min(data, function (d) {
                        return parseFloat(d.Fertility);
                    }), d3.max(data, function (d) {
                        return parseFloat(d.Fertility);
                    })])
                    .range([rRangeMin, rRangeMax]);

                // get max and min data for the fertility, GDO and Agriculture%
                minFertility = d3.min(data,
                    function (d) {
                        return parseFloat(d.Fertility);
                    });

                maxFertility = d3.max(data,
                    function (d) {
                        return parseFloat(d.Fertility);
                    })

                minGDP = d3.min(data,
                    function (d) {
                        return parseFloat(d.GDP);
                    });

                maxGDP = d3.max(data,
                    function (d) {
                        return parseFloat(d.GDP);
                    });

                minAgri = d3.min(data,
                    function (d) {
                        return parseFloat(d.Agriculture);
                    });

                maxAgri = d3.max(data,
                    function (d) {
                        return parseFloat(d.Agriculture);
                    });

                // Create scale to set the color on the maps
                AgriColorScale = d3.scale.linear()
                    .domain([minAgri, maxAgri])
                    .range([255, 0]);

                GDPColorScale = d3.scale.log()
                    .domain([minGDP, maxGDP])
                    .range([255, 0]);

                FertilityColorScale = d3.scale.linear()
                    .domain([minFertility, maxFertility])
                    .range([255, 0]);

                //Create dataset with year as keys
                //For more convenient access to yearly data
                dataset = d3.nest()
                    .key(function (d) {
                        return d.Year
                    })
                    .sortKeys(d3.ascending)
                    .map(data);

                //Create Year slider
                //get all unique years
                yearValues = d3.map(data, function (d) {
                    return d.Year;
                }).keys();
                //get years as integer
                for (var i = 0; i < yearValues.length; i++) {
                    yearValues[i] = +yearValues[i];
                };
                //sort years (just in case)
                //This is so that index 0 store the first year available
                //and the last index stores the data of the most recent year
                yearValues.sort();

                //create slider
                yearSlider = d3.slider()
                    .axis(true)
                    .min(0)
                    .max(yearValues.length - 1)
                    .step(1)
                    .on("slide", function (evt, value) {
                        stopAutoplay();
                        makeVisualization(yearValues[value]);
                        updateMap(yearValues[value]);
                    });

                //add slider to the page
                d3.select("#slider")
                    .call(yearSlider);

                // create X axis
                xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom")
                    .tickFormat(function (d) {
                        return xScale.tickFormat(8, d3.format(",d"))(d)
                    });

                //create Y axis
                yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left")
                    .ticks(5);

                //Create svg
                svg = d3.select("#visualization-div")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("id", "gapmindersvg");

                //Create background for the visualization
                svg.append("rect")
                    .attr("x", padding)
                    .attr("y", 100 - padding)
                    .attr("width", width - 150)
                    .attr("height", height - 100)
                    .style("fill", "#fcfcfc");

                //create clip path
                svg.append("clipPath")
                    .attr("id", "clippath")
                    .append("rect")
                    .attr("x", padding)
                    .attr("y", 100 - padding)
                    .attr("width", width - 150)
                    .attr("height", height - 100);

                //Append svg with the X axis
                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + (height - padding) + ")")
                    .call(xAxis)
                    .call(xAxis);

                //add X label
                svg.append("text")
                    .text("Income per person")
                    .attr("class", "axe-label-strong")
                    .attr("x", (width / 2))
                    .attr("y", height - 15)
                    .attr("text-anchor", "middle");

                svg.append("text")
                    .text("in USDollars (GDP/capita, PPP$ infation adjusted, log scale)")
                    .attr("class", "axe-label-mid")
                    .attr("x", (width / 2))
                    .attr("y", height - 5)
                    .attr("text-anchor", "middle");

                //Append svg with the Y axis
                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxis);

                //add Y label
                svg.append("text")
                    .text("Agriculture (% of GDP)")
                    .attr("class", "axe-label-strong")
                    .attr("x", -(height / 2))
                    .attr("y", 15)
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)");

                svg.append("text")
                    .text("value-added in USDollar")
                    .attr("class", "axe-label-mid")
                    .attr("x", -(height / 2))
                    .attr("y", 25)
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)");

                //Append svg with the X grid
                svg.append("g")
                    .attr("class", "grid")
                    .attr("transform", "translate(0," + (height - padding) + ")")
                    .call(xAxis
                        .tickSize(-(height - 100), 0, 0)
                        .tickFormat("")
                    )

                //Append SVG with the Y grid
                svg.append("g")
                    .attr("class", "grid")
                    .attr("transform", "translate(" + padding + ",0)")
                    .call(yAxis
                        .tickSize(-(width - 150), 0, 0)
                        .tickFormat(""))

                //Display current year
                svg.append("text")
                    .text(yearValues[0])
                    .attr("id", "currentyeardiplsayed")
                    .attr("x", width - 220)
                    .attr("y", padding + 55);

                // Africa label below year
                svg.append("rect")
                    .attr("x", width - 210) //was 195 (added 15)
                    .attr("y", padding + 65) //was 50 (added 15)
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("fill", "#3B8CCB")
                    .text("africa");

                svg.append("text")
                    .attr("class", "data-label")
                    .text("Africa")
                    .attr("x", width - 195)
                    .attr("y", padding + 75)


                //Asia label below year
                svg.append("rect")
                    .attr("x", width - 210)
                    .attr("y", padding + 80)
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("fill", "#ED61A5")
                    .text("africa");

                svg.append("text")
                    .attr("class", "data-label")
                    .text("Asia")
                    .attr("x", width - 195)
                    .attr("y", padding + 90)


                //Europe label below year
                svg.append("rect")
                    .attr("x", width - 210)
                    .attr("y", padding + 95)
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("fill", "#FBB82A")
                    .text("africa");

                svg.append("text")
                    .attr("class", "data-label")
                    .text("Europe")
                    .attr("x", width - 195)
                    .attr("y", padding + 105);

                //American label below year
                svg.append("rect")
                    .attr("x", width - 210)
                    .attr("y", padding + 110)
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("fill", "#71BF44")
                    .text("africa");

                svg.append("text")
                    .attr("class", "data-label")
                    .text("America")
                    .attr("x", width - 195)
                    .attr("y", padding + 120);


                //Bubble size label below year
                svg.append("ellipse") // using ellipse otherwise element is selected by selectAll("circle")
                    .attr("cx", width - 205)
                    .attr("cy", padding + 140)
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .style("fill", "black");

                svg.append("text")
                    .attr("class", "data-label")
                    .text("lower fertility")
                    .attr("x", width - 190)
                    .attr("y", padding + 145)


                svg.append("ellipse")
                    .attr("cx", width - 205)
                    .attr("cy", padding + 155)
                    .attr("rx", 10)
                    .attr("ry", 10)
                    .style("fill", "black");

                svg.append("text")
                    .attr("class", "data-label")
                    .text("higher fertility")
                    .attr("x", width - 190)
                    .attr("y", padding + 160)

                //

                //Generate visualisation
                launchAutoplay();
            }

        });

        function makeVisualization(year) {

            //get and sort the array.
            var currYearData = dataset[year];

            var country_bubbles = svg.selectAll("circle")
                .data(currYearData, function key(d) {
                    try {
                        return d.Code;
                    } catch (err) {

                    }
                });

            country_bubbles
                .transition()
                .duration(transitionDuration)
                .ease("linear")
                .attr("cx", function (d) {
                    return xScale(d.GDP);
                })
                .attr("cy", function (d) {
                    return yScale(d.Agriculture);
                })
                .attr("r", function (d) {
                    return rScale(d.Fertility);
                });

            country_bubbles.enter()
                .append("circle")
                .attr("clip-path", "url(#clippath)")
                .attr("id", function (d) {
                    return "circle-" + d.Code;
                })
                .on("mouseover", function (d) {
                    displayCountryName(d);
                })
                .on("mouseout", function (d) {
                    removeCountryName(d);
                })
                .attr("cx", function (d) {
                    return xScale(d.GDP);
                })
                .attr("cy", function (d) {
                    return yScale(d.Agriculture);
                })
                .style("stroke", "black")
                .style("fill", function (d) {
                    return color(d.Region);
                })
                .attr("r", 0)
                .transition()
                .duration(transitionDuration)
                .ease("elastic")
                .attr("r", function (d) {
                    return rScale(d.Fertility);
                });

            country_bubbles.exit()
                .transition()
                .duration(transitionDuration)
                .attr("r", 0)
                .remove();

            d3.select("#currentyeardiplsayed")
                .text(year);
        }

        //display name and details of a country
        function displayCountryName(d) {
            svg.append("text")
                .transition()
                .duration(500)
                .attr({
                    class: "selectedCountry",
                    // Create an id for text so we can select it later for removing on mouseout
                    x: 1025,
                    y: 105
                })
                .attr("text-anchor", "end")
                .text(function () {
                    return d.Country + " |";
                });

            svg.append("text")
                .transition()
                .duration(500)
                .attr({
                    class: "country-details",
                    // Create an id for text so we can select it later for removing on mouseout
                    x: 1020,
                    y: 140
                })
                .attr("text-anchor", "end")
                .text(function () {
                    return "Income per person: " +
                        (parseInt(d.GDP)).toLocaleString() + "$";
                });

            svg.append("text")
                .transition()
                .duration(500)
                .attr({
                    class: "country-details",
                    // Create an id for text so we can select it later for removing on mouseout
                    x: 1020,
                    y: 155
                })
                .attr("text-anchor", "end")
                .text(function () {
                    return "Agriculture: " +
                        (Math.round(d.Agriculture * 100) / 100) + "% of GDP";
                });

            svg.append("text")
                .transition()
                .duration(500)
                .attr({
                    class: "country-details",
                    // Create an id for text so we can select it later for removing on mouseout
                    x: 1020,
                    y: 170
                })
                .attr("text-anchor", "end")
                .text(function () {
                    return "Birth per woman (fertility rate): " + (Math.round(d.Fertility * 100) / 100);
                });

            svg.selectAll("circle")
                .transition()
                .duration(500)
                .style("opacity", 0.3)

            d3.select("#circle-" + d.Code)
                .transition()
                .duration(100)
                .style("opacity", 1);
        }

        //remove country name when mouse gets away from the country bubble
        function removeCountryName(d) {
            // Select text by id and then remove
            d3.selectAll(".selectedCountry")
                .transition()
                .duration(200)
                .remove();

            d3.selectAll(".country-details")
                .transition()
                .duration(200)
                .remove();

            svg.selectAll("circle")
                .transition()
                .duration(200)
                .style("opacity", 1);
        }

        // Pick a color for the country bubble
        function color(region) {
            switch (region) {
            case "Asia":
                return "#ED61A5";

            case "Africa":
                return "#3B8CCB";

            case "Europe":
                return "#FBB82A";

            case "North America":
                return "#71BF44";

            case "South America":
                return "#71BF44";

            case "Australia":
                return "#ED61A5";

            case "Central America":
                return "#71BF44";

            case "Oceania":
                return "#ED61A5";

            }
        }

        //turn autoplay on and off
        function controlAutoplay() {
            img = document.getElementById("play-button");
            if (autoplaying) {
                img.src = "img/play.png";
                autoplaying = false;
                clearInterval(autoplay);
            } else {
                img.src = "img/pause.png";
                autoplaying = true;
                launchAutoplay();
            }
        }

        function stopAutoplay() {
            document.getElementById("play-button").src = "img/play.png";
            autoplaying = false;
            clearInterval(autoplay);
        }

        //generates autoplay!
        function launchAutoplay() {
            var i = yearSlider.value();
            autoplay = setInterval(function () {
                moveSlider(i % (yearSlider.max() + 1));
                makeVisualization(yearValues[yearSlider.value()]);
                updateMap(yearValues[yearSlider.value()]);
                i += 1;
            }, 700);
        }


        //moves the slider handler and updates visualization
        function moveSlider(newVal) {
            if (newVal == 0) {
                d3.selectAll('circle').remove();
            }
            yearSlider.value(newVal);
        }

        //create maps (no data -- all countries are grey)
        var map1 = new Datamap({
            scope: 'world',
            element: document.getElementById('container1'),
            projection: 'mercator',
            width: 400,
            height: 400,
            fills: {
                defaultFill: '#d3d3d3'
            }
        });

        var map2 = new Datamap({
            scope: 'world',
            element: document.getElementById('container2'),
            projection: 'mercator',
            width: 400,
            height: 400,
            fills: {
                defaultFill: '#d3d3d3'
            }
        });

        var map3 = new Datamap({
            scope: 'world',
            element: document.getElementById('container3'),
            projection: 'mercator',
            width: 400,
            height: 400,
            fills: {
                defaultFill: '#d3d3d3'
            }
        });

        //generate data for the maps and populate the map with the data
        function updateMap(year) {

            //reset the maps
            map1.updateChoropleth(null, {
                reset: true
            });
            map2.updateChoropleth(null, {
                reset: true
            });
            map3.updateChoropleth(null, {
                reset: true
            });

            // create array of relevant data
            var myArray = dataset[year].map(function (d) {
                return [d.Code, d.Fertility, d.GDP, d.Agriculture];
            });

            // define new dictionaries
            var dicMap1 = {};
            var dicMap2 = {};
            var dicMap3 = {};

            // add data to the dictionaries
            myArray.forEach(function (country) {
                dicMap1[country[0]] = pickColorIntensity("fertility", country[1]);
                dicMap2[country[0]] = pickColorIntensity("GDP", country[2]);
                dicMap3[country[0]] = pickColorIntensity("Agri", country[3]);
            });

            // update the maps
            map1.updateChoropleth(dicMap1);
            map2.updateChoropleth(dicMap2);
            map3.updateChoropleth(dicMap3);
        }


        //return the color intensity for a map (from light blue to dark blue)
        function pickColorIntensity(type, value) {
            if (type == "fertility") {
                return "rgb(0, " + FertilityColorScale(value) + ", 255)";
            }

            if (type == "GDP") {
                return "rgb(0, " + GDPColorScale(value) + ", 255)";
            }

            if (type == "Agri") {
                return "rgb(0, " + AgriColorScale(value) + ", 255)";
            }
        }
    </script>

</body>

</html>